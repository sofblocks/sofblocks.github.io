---
layout: single
title: "Azure Cloud Pentesting"
permalink: /azure-cloud-pentesting/
toc: true
tags: [Azure, Pentesting, Service Principal, Privileges Escalation, Authentication]
header: 
    header:  "assets/imgs/notes/azurepen.jpg"
    teaser: "assets/imgs/notes/azurepen.jpg"
    og_image: "assets/imgs/notes/azurepen.jpg"
---

The rise of cloud computing has seen many companies shifting their attention to adopting cloud services such as storage, network, database, and software applications among others.

This particular technology adoption has allowed companies to improve customer experience, increase productivity, lower costs and improve business continuity. While there are many advantages to cloud computing there are also disadvantages to it.

One of the major issues is, it has provided an avenue of attack for cybercriminals mainly because of how organizations are using, storing, and sharing information.

The number of attacks on cloud platforms has increased rapidly in recent years and since cloud computing is here to stay organizations need to know how to prevent themselves from these attacks.

It starts with cloud customers understanding the shared responsibility model offered by their cloud provider. There should be a fine line between what security tasks the customer is expected to handle and what the cloud provider handles. Microsoft clearly states that the customer is responsible for protecting the security of their data and identities, on-premises resources, and the cloud components they control. 

Therefore, users have a responsibility to maintain their cloud tenant security by performing regular security audits and assessments. The security assessment process can be complex and proper protocols have to be followed to keep other clients from becoming affected by these planned tests.

All cloud providers have a clear policy of what is permitted when it comes to performing security assessments on customer environments. For Microsoft, the rules of engagement are detailed [here.](https://www.microsoft.com/en-us/msrc/pentest-rules-of-engagement)

Some of its products permitted for pentest in the Azure environment include:

 Azure AD tenant configurations, Microsoft Intune, Office 365, and Azure DevOps among others.

In this blog post, we will be focusing on Azure AD security assessment, particularly on the applications that have been registered in Azure AD tenant. Developers register these applications so as to delegate identity and access management functions to Azure AD.

As a security engineer, you may be tasked with enumerating excessive privileges that may allow potential internal Azure users, especially developers to take over the Azure environment.  

These privileged identities are normally targeted by Cyber attackers through credentials theft attacks and other means so as to gain access to sensitive data.

We are going to look at how to perform an Azure AD security assessment to locate these privileged identities, but first, let us familiarize ourselves with some of the Microsoft Azure environment terms.

**Azure Tenant -** An instance of Azure AD. This tenant can represent a single identity (person, company, or organization) and can own one or several subscriptions.

**Role** - A role is made up of a name and a set of operations that can be performed, such as read, write, and delete. Azure controls access to resources using two main systems, RBAC and Azure AD roles.  Azure role-based access control (Azure RBAC), controls access to Azure resources such as virtual machines or storage using Azure Resource Management while Azure AD roles control access to Azure AD resources such as users, groups, and applications using the Microsoft Graph API.

**Azure app registration** - Represent an application that is being created in the tenant. when you register an app in Azure AD two objects are created.

1. **Application object** which is the global definition of the application, you can call it a blueprint.
2. **Service principal** which is the local instantiation of the application. This is the object that will be managing the app. Whenever the app wants to authenticate to Azure AD and access Azure resources it will do so using this service principal object.   

**Enterprise application** - Basically, represents a list of service principals registered in the tenant. 

**Microsoft Graph -** is a RESTful web API that enables you to access Microsoft Cloud service resources. Applications and service principals can authenticate to Microsoft and gain access to the API using:

- Secretes - passwords
- Certificates

 **Scope**: These are permissions for a given resource that represent what a client application can access on behalf of the user.

The Microsoft Graph has two categories of permissions: **application permissions and delegated permissions**. Application permissions allow an app to act as any user, while delegated permissions are used by **apps that have a signed-in user present**.

### Recon:

Let us start our reconnaissance process. As a security engineer,  you will authenticate as any Azure AD user in the subject tenant using Powershell.  We will be using the PowerShell AZ module.

The module can be installed on any machine with the following command.

```powershell
Install-Module -Name AzureAD  -Force
```

Connect to Azure tenant any user account’s credentials.

```powershell
connect-AzureAD
```

Enter the credentials on the Microsoft sign-in window that pops up.

### Enumerating Users roles

Once we have logged in to the tenant, will start by listing roles that have been activated and assigned to users. We will use a PowerShell cmdlet called Get-AzureADDirectoryRole.  Note that the roles we are enumerating here are Azure AD roles and not Azure RBAC roles. 

![upload-image]({{ "/assets/imgs/notes/rolesenum.png" | relative_url }})

From the screenshot above we can see that the roles Application and Privilege role admins have been activated in the tenant which means one or more azure Ad users might have been assigned these roles. Also, we have a global admin role that has been assigned to one or more azure ad users. 

Users with an Application admin role can create and manage all aspects of enterprise applications, application registrations, and application proxy settings.

Privileged Role Administrator, Can manage role assignments in Azure AD, and all aspects of Privileged Identity Management.

Global administrator – the highest level of access, including the ability to grant administrator access to other users and to reset other administrators’ passwords.

### Enumerating the Application Administrators role

Let us enumerate any Azure AD users assigned to the Application Administrators role.

Application Administrators can reset credentials or client secrets for any application Service Principal in an Azure AD tenant this means it holds special privileges that open up specific privilege escalation attack primitives using Service Principals.

From the previous command we have run, we will grab the object ID of the application administrator role

To search for any users assigned to this role we will run the Get-AzureADDirectoryRoleMember cmdlet and then filter the results on the -ObjectId

```powershell
objectID: "47042d90-3a98-43d8-86f4-f1a00b62f213"
```

![upload-image]({{ "/assets/imgs/notes/appadmin.png" | relative_url }})

We get one  Azure AD user assigned to the Application Administrator role.

Save the User principal name in a variable called appadmin_username